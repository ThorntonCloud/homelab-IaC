server:
  service:
    type: ClusterIP
    
configs:
  params:
    server.insecure: true

repoServer:
  # Mount the age key secret
  volumes:
    - name: sops-age
      secret:
        secretName: sops-age
    - name: custom-tools
      emptyDir: {}
  
  volumeMounts:
   - mountPath: /usr/local/bin/kustomize
     name: custom-tools
     subPath: kustomize
   - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops
     name: custom-tools
     subPath: ksops
   - mountPath: /.config/sops/age/keys.txt
     name: sops-age
     subPath: keys.txt
  
  # Install KSOPS via init container
  initContainers:
    - name: install-ksops
      image: viaductoss/ksops:v4.3.2
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo 'Installing KSOPS...'
          cp ksops /custom-tools/
          cp $GOPATH/bin/kustomize /custom-tools/
          echo "Done."

      volumeMounts:
        - name: custom-tools
          mountPath: /custom-tools
  
  # Environment variables for SOPS
  env:
    - name: XDG_CONFIG_HOME
      value: /.config
    - name: SOPS_AGE_KEY_FILE
      value: /.config/sops/age/keys.txt